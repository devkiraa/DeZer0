name: Build ESP-IDF Firmware

on:
  push:
    branches: [ main ]
    paths:
      - 'firmware/**'
      - '.github/workflows/build-firmware.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'firmware/**'
  workflow_dispatch:  # Allow manual triggering

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: 'recursive'
    
    - name: ESP-IDF Build
      uses: espressif/esp-idf-ci-action@v1
      with:
        esp_idf_version: v5.0
        target: esp32
        path: 'firmware'
    
    - name: Organize binaries
      run: |
        mkdir -p firmware_bins
        cp firmware/build/bootloader/bootloader.bin firmware_bins/
        cp firmware/build/partition_table/partition-table.bin firmware_bins/
        cp firmware/build/dezero_firmware.bin firmware_bins/
        
        # Create flash script
        cat > firmware_bins/flash.sh << 'EOF'
        #!/bin/bash
        esptool.py -p /dev/ttyUSB0 -b 460800 --before default_reset --after hard_reset write_flash --flash_mode dio --flash_freq 40m --flash_size 4MB \
          0x1000 bootloader.bin \
          0x8000 partition-table.bin \
          0x10000 dezero_firmware.bin
        EOF
        chmod +x firmware_bins/flash.sh
        
        # Create PowerShell flash script
        cat > firmware_bins/flash.ps1 << 'EOF'
        esptool.py -p COM3 -b 460800 --before default_reset --after hard_reset write_flash --flash_mode dio --flash_freq 40m --flash_size 4MB 0x1000 bootloader.bin 0x8000 partition-table.bin 0x10000 dezero_firmware.bin
        EOF
        
        ls -lh firmware_bins/
    
    - name: Upload firmware artifacts
      uses: actions/upload-artifact@v4
      with:
        name: dezero-firmware-${{ github.sha }}
        path: firmware_bins/
        retention-days: 30
    
    - name: Create Release (on tag push)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          firmware_bins/bootloader.bin
          firmware_bins/partition-table.bin
          firmware_bins/dezero_firmware.bin
          firmware_bins/flash.sh
          firmware_bins/flash.ps1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
